% !TEX TS-program = pdflatex
% !TEX encoding = UTF-8 Unicode

% This is a simple template for a LaTeX document using the "article" class.
% See "book", "report", "letter" for other types of document.

\documentclass[12pt]{scrartcl} % use larger type; default would be 10pt

\usepackage[utf8]{inputenc} % set input encoding (not needed with XeLaTeX)

%%% Examples of Article customizations
% These packages are optional, depending whether you want the features they provide.
% See the LaTeX Companion or other references for full information.

%%% PAGE DIMENSIONS
\usepackage{geometry} % to change the page dimensions
\geometry{a4paper} % or letterpaper (US) or a5paper or....
% \geometry{margin=2in} % for example, change the margins to 2 inches all round
% \geometry{landscape} % set up the page for landscape
%   read geometry.pdf for detailed page layout information

\usepackage{graphicx} % support the \includegraphics command and options

% \usepackage[parfill]{parskip} % Activate to begin paragraphs with an empty line rather than an indent

%%% PACKAGES
\usepackage{booktabs} % for much better looking tables
\usepackage{array} % for better arrays (eg matrices) in maths
\usepackage{paralist} % very flexible & customisable lists (eg. enumerate/itemize, etc.)
\usepackage{verbatim} % adds environment for commenting out blocks of text & for better verbatim
\usepackage{subfig} % make it possible to include more than one captioned figure/table in a single float
% These packages are all incorporated in the memoir class to one degree or another...

%%% HEADERS & FOOTERS
\usepackage{fancyhdr} % This should be set AFTER setting up the page geometry
\pagestyle{fancy} % options: empty , plain , fancy
\renewcommand{\headrulewidth}{0pt} % customise the layout...
\lhead{}\chead{}\rhead{}
\lfoot{}\cfoot{\thepage}\rfoot{}

%%% SECTION TITLE APPEARANCE
\usepackage{sectsty}
\allsectionsfont{\sffamily\mdseries\upshape} % (See the fntguide.pdf for font help)
% (This matches ConTeXt defaults)

%%% ToC (table of contents) APPEARANCE
\usepackage[nottoc,notlof,notlot]{tocbibind} % Put the bibliography in the ToC
\usepackage[titles,subfigure]{tocloft} % Alter the style of the Table of Contents
\renewcommand{\cftsecfont}{\rmfamily\mdseries\upshape}
\renewcommand{\cftsecpagefont}{\rmfamily\mdseries\upshape} % No bold!

\usepackage{csquotes}
\usepackage[breaklinks=true]{hyperref}

%%% END Article customizations

%%% The "real" document content comes below...

\title{Motion Browser}
\author{Nigel D. Pegram}
%\date{} % Activate to display a given date or no date (if empty),
         % otherwise the current date is printed

\begin{document}
\maketitle
\tableofcontents

\section{Readme}
	Browser-based user interface for the Motion application.
	Developed by Carlos Ladeira (\href{mailto:caladeira@gmail.com}{caladeira@gmail.com}),
	Updated by Nigel D. Pegram (\href{mailto:ndpegram@gmail.com}{ndpegram@gmail.com}).
	This software is distributed under the GNU public license.

	Tested with Motion 4.0

	This web page reads the mysql database filled by Motion and
	output events by day 	It creates small thumbnail were you can click to watch the movie
	file for the same event. You can also delete the events you select.

	It's a good interface in case you are running Motion on a computer
	without monitor/keyboad/mouse, only network!

	It is supposed to work with the following motion.conf
	options set as shown (for better results):

	\begin{verbatim}
		pre_capture 8		(works for me with a framerate of 6)
		post_capture 8		(ie)
		output_all off
		output_normal best (or) first
		output_motion off
		text_event %Y%m%d%H%M%S
		ffmpeg_cap_new on
		ffmpeg_video_codec msmpeg4
		sql_log_image on
		sql_log_snapshot off
		sql_log_mpeg on
		sql_log_timelapse off
		sql_query INSERT ...	(I use the default)
		mysql_db motion		(my database name)
		mysql_host localhost
		mysql_user ...		(the user name i created in MySQL)
		mysql_password ...	(the password associated with user)
	\end{verbatim}

\section{Installation}

	\subsection{File system}
	Install the files into the appropriate location in your web software's file tree.

	The directory where you store your motion files must be writeable by the user under which
	the web software is running. In Ubuntu, for example, this is the \texttt{www-data} user.
	For example, if the directory to which motion is saving the video and image files is \texttt{/var/lib/motion},
	then you should issue the following (assuming the web user is \texttt{www-data}).
	You will likely need to issue this commands as a superuser.
	\begin{verbatim}
		sudo chgrp -R www-data /var/lib/motion
		sudo chmod -R g+rw /var/lib/motion
	\end{verbatim}

	\subsection{mySQL}
	Use the following to create your mySQL table.

	\begin{verbatim}
		CREATE TABLE `security` (
		  `camera` int(11) DEFAULT NULL,
		  `filename` varchar(80) NOT NULL DEFAULT '',
		  `frame` int(11) DEFAULT NULL,
		  `file_type` int(11) DEFAULT NULL,
		  `time_stamp` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
		  `text_event` varchar(40) NOT NULL DEFAULT '0000-00-00 00:00:00',
		  `event_time_stamp` timestamp NOT NULL DEFAULT '2000-01-01 00:00:00',
		  `file_size` varchar(36) NOT NULL DEFAULT '0',
		  KEY `time_stamp` (`time_stamp`),
		  KEY `event_time_stamp` (`event_time_stamp`)
		) ENGINE=InnoDB DEFAULT CHARSET=utf8
	\end{verbatim}

	\subsection {Apache}
	You need to set the appropriate values in the security.conf apache settings file.
	\begin{description}
		\item [ServerName] should be set to the name under which you will serve the site.
		%TODO: May not need the proxy to \live, as the camera icon and settings links provide this.
		\item [ProxyPass and ProxyPassReverse] URLs should be set to the address where motion is running. This address should use dotted quad notation and include the port.

			For example: \texttt{http://192.168.2.42:9080/}, where 192.168.2.42 is the server where the motion service is running and 9080 is the port where motion is running (see \texttt{webcontrol\_port} in the \texttt{motion.conf} file.).
		\item[DocumentRoot] should be set to the fully-qualified path of where you intalled the MotionBrowser files
		\item[Other] Log names and locations can be set as required.
	\end{description}



\section{History}

	\subsection{Version 1.2}
		\begin{description}
			\item [20190602] Largely internal reorganisation
			\begin{itemize}
				\item Converted from GET to POST, to allow deletion of
						selection of large number of videos on one day.
						This includes removal of overarching form in HTML
						code and using javascript to post and AJAX instead.
				\item Converted from PHP include files to gettext for
						internationalisation.
				\item Use AJAX for integration of internationalisation
						of javascript messages (alert/confirm) with PHP gettext calls.
						Thus only one set of internationalisation files are required.
				\item Miscellaneous bug fixes and enhancements.
			\end{itemize}
		\end{description}

	\subsection{Version 1.1}
		\begin{description}
			\item [20190422] 	Adapted by Nigel Pegram.
			\begin{itemize}
				\item	Updated to PHP 7 and mySQL 14
				\item	Adjusted to stream video files rather than download
				\item	Miscellaneous bug fixes.
			\end{itemize}
		\end{description}

	\subsection{Version 1.0}
		\begin{description}
			\item [20060000] 	Original Carlos Ladeira version.
		\end{description}



\section{To Do/Planned features}

	\begin{itemize}
		\item Update the code to object-oriented format

		\item Add link to video preview \enquote{box} to allow downloading of file, rather
		than streaming. (Is this necessary since we can do this from the stream?)

		\item Add button to delete data and files based on user-selected date.

		\item Building on the above, add settings and code to respond to disk free space falling below a preset level.
		This should trigger a warning/dialog, which the user can then set a date up to which
		all files and database rows are deleted. There are a number of possible ways to implement this:
		\begin{enumerate}
			\item Insert a date into a file which a cron script reads
			and acts on during low load periods.
			\item Delete from within the web browser
			(problematic as it will tie up the browser when, presumably,
			the user will want to interact with it).
			\item Use a hybrid approach. Delete the database rows immediately, but write out the files to delete for later crontab processing. The advantage of this approach is that the items will no longer display in the browser and the interface should remain responsive.
			\begin{description}
				\item [Question:] where to save the list of text files? Possible locations are /etc/motion or the files directory. The latter seems preferable. It seems wise to set this as a variable in the config file which defaults to the files directory.
			\end{description}
		\end{enumerate}

	\end{itemize}

\end{document}
